pipeline {
    agent any

    environment {
        REGISTRY   = 'git.h4ckdata.es'
        // Configura GITEA_IMAGE como variable de entorno del job en Jenkins
        // (ej: git.h4ckdata.es/h4ckx0r/makethis) o modifica el valor por defecto aqu√≠
        IMAGE_NAME = "${env.GITEA_IMAGE ?: "${REGISTRY}/usuario/makethis"}"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Set Build Variables') {
            steps {
                script {
                    // Primeros 7 caracteres del SHA del commit
                    env.IMAGE_TAG = env.GIT_COMMIT.take(7)
                    echo "Construyendo imagen: ${IMAGE_NAME}:${env.IMAGE_TAG}"
                }
            }
        }

        stage('Build Production Image') {
            steps {
                sh """
                    docker build \
                        --file devops/Dockerfile.prod \
                        --tag ${IMAGE_NAME}:${env.IMAGE_TAG} \
                        --tag ${IMAGE_NAME}:latest \
                        .
                """
            }
        }

        stage('Push to Gitea Registry') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'gitea-registry',
                        usernameVariable: 'REGISTRY_USER',
                        passwordVariable: 'REGISTRY_PASS'
                    )
                ]) {
                    sh """
                        echo "${REGISTRY_PASS}" | docker login ${REGISTRY} \
                            --username "${REGISTRY_USER}" \
                            --password-stdin

                        docker push ${IMAGE_NAME}:${env.IMAGE_TAG}
                        docker push ${IMAGE_NAME}:latest
                    """
                }
            }
        }
    }

    post {
        always {
            sh """
                docker rmi ${IMAGE_NAME}:${env.IMAGE_TAG} || true
                docker rmi ${IMAGE_NAME}:latest            || true
                docker logout ${REGISTRY}                  || true
            """
        }
    }
}
